# 文件选择组件实现示例

## 什么是文件选择组件？

文件选择组件是让用户通过图形界面选择文件或目录的 UI，包含：

1. **输入框**（JTextField）：显示所选路径
2. **浏览按钮**（JButton）：打开文件选择对话框
3. **可选图标**：表示按钮功能

## 在 IntelliJ IDEA 插件中的实现

### 方法一：使用 IntelliJ Platform API（推荐）

#### 1. 导入必要的类

```java
import com.intellij.openapi.fileChooser.FileChooser;
import com.intellij.openapi.fileChooser.FileChooserDescriptor;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.ui.TextFieldWithHistory;
```

#### 2. 创建文件选择器组件

```java
// 方式 1: 使用 TextFieldWithBrowseButton（简单推荐） 
private TextFieldWithBrowseButton picListExeTextField;

// 或者方式 2: 手动创建 JTextField + JButton
private JTextField picListExeTextField;
private JButton picListExeBrowseButton;
```

#### 3. 实现浏览按钮点击事件

在 `initAuthorizationTabbedPanel()` 或其他初始化方法中添加：

```java
// 为浏览按钮添加点击事件
picListExeBrowseButton.addActionListener(e -> {
    // 创建文件选择描述符
    FileChooserDescriptor descriptor = new FileChooserDescriptor(
        true,  // 是否可以选择文件
        false, // 是否可以选择目录
        false, // 是否可以多个
        false  // 是否必须存在
    );
    
    // 设置标题
    descriptor.setTitle("选择 PicList 可执行文件");
    
    // 设置文件过滤器（可选）
    descriptor.setDescription("请选择 PicList 可执行文件（.exe、.AppImage 或 .app）");
    
    // 限制可执行文件
    descriptor.withFileFilter(virtualFile -> {
        String name = virtualFile.getName().toLowerCase();
        return name.endsWith(".exe") || 
               name.endsWith(".appimage") || 
               name.endsWith(".app");
    });
    
    // 打开文件选择对话框
    VirtualFile selectedFile = FileChooser.chooseFile(
        descriptor,
        null,  // 项目，可以为 null
        myMainPanel,
        null   // 初始目录，可以为 null
    );
    
    // 如果用户选择了文件，更新输入框
    if (selectedFile != null) {
        picListExeTextField.setText(selectedFile.getPath());
    }
});
```

### 方法二：使用 TextFieldWithBrowseButton（最简单）

这是 IntelliJ 平台提供的现成组件，直接支持浏览功能：

```java
import com.intellij.openapi.ui.TextFieldWithBrowseButton;

// 1. 声明组件
private TextFieldWithBrowseButton picListExeTextField;

// 2. 在 initAuthorizationTabbedPanel() 中配置
private void initPicListExeBrowser() {
    // 创建文件选择描述符
    FileChooserDescriptor descriptor = new FileChooserDescriptor(
        true, false, false, false
    );
    
    descriptor.setTitle("选择 PicList 可执行文件");
    descriptor.setDescription("PicList 可执行文件（.exe、.app、.AppImage）");
    
    // 添加浏览按钮功能
    picListExeTextField.addBrowseFolderListener(
        descriptor.getTitle(),
        descriptor.getDescription(),
        null,  // 项目
        descriptor,
        TextComponentAccessor.TEXT_FIELD_WHOLE_TEXT
    );
}
```

### 方法三：使用标准 JFileChooser（不推荐）

```java
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileNameExtensionFilter;

// 在按钮点击事件中
picListExeBrowseButton.addActionListener(e -> {
    JFileChooser fileChooser = new JFileChooser();
    
    // 设置文件过滤器
    FileNameExtensionFilter filter = new FileNameExtensionFilter(
        "可执行文件", "exe", "app", "AppImage"
    );
    fileChooser.setFileFilter(filter);
    
    // 打开选择对话框
    int result = fileChooser.showOpenDialog(myMainPanel);
    
    if (result == JFileChooser.APPROVE_OPTION) {
        File selectedFile = fileChooser.getSelectedFile();
        picListExeTextField.setText(selectedFile.getAbsolutePath());
    }
});
```

## 完整的实现示例

### 1. 在 ProjectSettingsPage.java 中添加方法

```java
/**
 * 初始化 PicList 可执行文件选择器
 */
private void initPicListExeBrowser() {
    // 使用 TextFieldWithBrowseButton
    if (picListExeTextField instanceof TextFieldWithBrowseButton) {
        FileChooserDescriptor descriptor = new FileChooserDescriptor(
            true, false, false, false
        );
        
        descriptor.setTitle("选择 PicList 可执行文件");
        descriptor.setDescription("PicList 命令行工具可执行文件");
        
        ((TextFieldWithBrowseButton) picListExeTextField)
            .addBrowseFolderListener(
                descriptor.getTitle(),
                descriptor.getDescription(),
                null,
                descriptor,
                TextComponentAccessor.TEXT_FIELD_WHOLE_TEXT
            );
    } 
    // 或者使用 JButton
    else if (picListExeBrowseButton != null) {
        picListExeBrowseButton.addActionListener(e -> {
            FileChooserDescriptor descriptor = new FileChooserDescriptor(
                true, false, false, false
            );
            descriptor.setTitle("选择 PicList 可执行文件");
            
            VirtualFile selectedFile = FileChooser.chooseFile(
                descriptor,
                null,
                myMainPanel,
                null
            );
            
            if (selectedFile != null) {
                picListExeTextField.setText(selectedFile.getPath());
            }
        });
    }
}
```

### 2. 在初始化方法中调用

```java
private void initAuthorizationTabbedPanel(@NotNull MikState state) {
    // ... 其他代码 ...
    
    this.picListOssSetting.init(this.config.getState().getPicListOssState());
    
    // 初始化文件选择器
    this.initPicListExeBrowser();
    
    this.testAndHelpListener();
}
```

## 在 GUI Designer 中的配置

### 使用 TextFieldWithBrowseButton

1. 在 `.form` 文件中添加组件
2. 组件类型：`com.intellij.openapi.ui.TextFieldWithBrowseButton`
3. Binding 名称：`picListExeTextField`

```xml
<component id="piclist-exe" class="com.intellij.openapi.ui.TextFieldWithBrowseButton" binding="picListExeTextField">
  <constraints>
    <grid row="0" column="0" row-span="1" col-span="2" vsize-policy="0" hsize-policy="6" anchor="8" fill="1" indent="0"/>
  </constraints>
</component>
```

### 使用 JTextField + JButton

```xml
<!-- 输入框 -->
<component id="piclist-exe-text" class="javax.swing.JTextField" binding="picListExeTextField">
  <constraints>
    <grid row="0" column="0" vsize-policy="0" hsize-policy="6" anchor="8" fill="1"/>
  </constraints>
</component>

<!-- 浏览按钮 -->
<component id="piclist-exe-browse" class="javax.swing.JButton" binding="picListExeBrowseButton">
  <constraints>
    <grid row="0" column="1"/>
  </constraints>
  <properties>
    <text value="浏览..."/>
  </properties>
</component>
```

## 推荐方案

对于您的场景，推荐使用 **TextFieldWithBrowseButton**，因为：

1. ✅ 代码更简洁
2. ✅ 与 IntelliJ 风格一致
3. ✅ 自动处理平台差异
4. ✅ 内置输入验证

## 配置字段名称

确保在 UI 中的字段名称与代码中声明的一致：

- **TextFieldWithBrowseButton**: `picListExeTextField`
- **JTextField + JButton**: `picListExeTextField` + `picListExeBrowseButton`

## 注意事项

1. **文件权限**：确保选择的文件有执行权限
2. **路径格式**：Windows、macOS、Linux 路径格式不同
3. **验证逻辑**：添加文件存在性和可执行性检查
4. **跨平台**：考虑不同操作系统的路径格式

## 测试建议

1. 测试选择正确文件后的路径显示
2. 测试取消选择对话框
3. 测试选择无效文件时的提示
4. 测试不同操作系统上的行为
