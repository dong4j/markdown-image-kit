# 图片粘贴与 Markdown 转换功能实现总结

## 功能概述

本次实现完成了一个灵活的图片粘贴与 Markdown 转换功能，支持通过配置参数控制图片的处理方式和路径生成策略。

## 新增配置参数

在 `MikState` 类中新增了以下配置参数：

| 参数名                  | 类型      | 说明                                                |
|----------------------|---------|---------------------------------------------------|
| `applyToLocalImages` | boolean | 是否将本地图片（包括粘贴的图片流和文件）拷贝到指定路径                       |
| `preferRelativePath` | boolean | 是否在 Markdown 中使用相对路径                              |
| `addDotSlash`        | boolean | 是否在相对路径前添加 "./"（仅在 preferRelativePath = true 时生效） |
| `currentInsertPath`  | String  | 图片写入的目标目录，例如 ./imgs                               |
| `autoEscapeImageUrl` | boolean | 是否自动转义图片 URL 中的特殊字符（如中文、空格等）                      |

## 核心实现

### 1. 扩展数据模型

**文件**: `MarkdownImage.java`

新增字段：

- `sourceFilePath`: 源文件的绝对路径，用于粘贴文件时保存原始文件路径
- `isImageStream`: 标记图片是否为图片流（true）还是文件（false）

```java
/** 源文件的绝对路径，用于粘贴文件时保存原始文件路径 */
private String sourceFilePath;
/** 标记图片是否为图片流（true）还是文件（false） */
private boolean isImageStream = true;
```

### 2. 修改剪贴板数据解析

**文件**: `PasteImageAction.java`

#### 关键修改点：

**resolveFromFile 方法**

- 修改了文件解析逻辑，在 key 中保存文件的元数据
- 格式：`file:原始文件绝对路径|文件名`
- 这样可以在后续处理中区分文件和图片流，并保留原始路径信息

**getMarkdownImage 方法**

- 扩展了元数据解析逻辑
- 支持三种类型：网络图片（network:）、文件（file:）、图片流（其他）
- 根据类型设置相应的字段值

```java
if (key.startsWith("network:")) {
    // 处理网络图片
} else if (key.startsWith("file:")) {
    // 处理文件
    markdownImage.setSourceFilePath(sourceFilePath);
    markdownImage.setImageStream(false);
} else {
    // 处理图片流
    markdownImage.setImageStream(true);
}
```

### 3. 路径处理工具类

**文件**: `PathUtils.java`

提供了完整的路径处理工具方法：

| 方法名                           | 功能                        |
|-------------------------------|---------------------------|
| `calculateRelativePath`       | 计算源文件相对于 Markdown 文档的相对路径 |
| `calculateTargetRelativePath` | 计算目标目录下图片的相对路径            |
| `getAbsolutePath`             | 获取图片的绝对路径                 |
| `addDotSlashPrefix`           | 为相对路径添加 "./" 前缀           |
| `escapeImageUrl`              | 转义图片 URL 中的特殊字符           |
| `normalizePathSeparator`      | 规范化路径分隔符（统一使用正斜杠）         |
| `isAbsolutePath`              | 判断路径是否为绝对路径               |

**URL 转义实现**：

```java
public static String escapeImageUrl(@NotNull String path) {
    // 分割路径，对每个部分分别编码
    String[] parts = path.split("/", -1);
    // 对于 "."、".." 不进行编码
    // 使用 URLEncoder 进行编码，将 + 替换为 %20
    // 保持路径分隔符 "/" 不被编码
}
```

### 4. 重构图片存储处理器

**文件**: `ImageStorageHandler.java`

#### 核心设计

采用策略模式，根据图片类型分别处理：

```java
if (markdownImage.getLocation() == ImageLocationEnum.NETWORK) {
    processNetworkImage(...);
} else if (markdownImage.isImageStream()) {
    processImageStream(...);
} else {
    processImageFile(...);
}
```

#### 处理逻辑

**网络图片处理** (`processNetworkImage`)

- 网络图片始终拷贝到 `currentInsertPath`
- 仅区分相对路径与绝对路径

**图片流处理** (`processImageStream`)

- 图片流始终需要保存到文件
- 根据 `preferRelativePath` 决定使用相对路径还是绝对路径
- 根据 `addDotSlash` 决定是否添加 "./" 前缀

**文件处理** (`processImageFile`)

- 根据 `applyToLocalImages` 决定是否拷贝文件
- 如果拷贝：使用 `currentInsertPath`，根据 `preferRelativePath` 生成路径
- 如果不拷贝：使用原文件路径，根据 `preferRelativePath` 决定相对或绝对路径

#### 辅助方法

- `saveImageToFile`: 保存图片到文件系统
- `generateImagePath`: 生成图片路径
- `updateMarkdownImage`: 更新 MarkdownImage 对象，应用 URL 转义

## 功能特性

### 1. 灵活的路径控制

支持 4 种主要配置组合，覆盖不同的使用场景：

| applyToLocalImages | preferRelativePath | 图片流行为   | 文件行为     |
|--------------------|--------------------|---------|----------|
| false              | false              | 绝对路径    | 不拷贝，绝对路径 |
| true               | false              | 拷贝，绝对路径 | 拷贝，绝对路径  |
| true               | true               | 拷贝，相对路径 | 拷贝，相对路径  |
| false              | true               | 拷贝，相对路径 | 不拷贝，相对路径 |

### 2. URL 转义

- 自动转义中文字符
- 转义空格为 `%20`
- 保持路径分隔符 `/` 不被转义
- 保持特殊路径 `.` 和 `..` 不被转义
- 示例：`./中文目录/img.png` -> `./%E4%B8%AD%E6%96%87%E7%9B%AE%E5%BD%95/img.png`

### 3. 跨平台兼容

- 统一使用正斜杠作为路径分隔符
- 在 Windows、macOS、Linux 上都能正常工作
- Java 的 File 类能够正确处理正斜杠

### 4. 相对路径计算

- 使用 Java NIO 的 `Path.relativize()` 方法
- 自动处理 `../` 的情况
- 支持跨目录的相对路径计算

## 代码结构

```
markdown-image-kit/
├── src/main/java/info/dong4j/idea/plugin/
│   ├── entity/
│   │   └── MarkdownImage.java              # 扩展了数据模型
│   ├── action/paste/
│   │   └── PasteImageAction.java           # 修改了剪贴板解析逻辑
│   ├── chain/
│   │   └── ImageStorageHandler.java        # 重构了图片存储处理器
│   ├── util/
│   │   └── PathUtils.java                  # 新增路径处理工具类
│   └── settings/
│       └── MikState.java                   # 新增配置参数
└── docs/
    ├── IMAGE_PASTE_TEST_GUIDE.md           # 测试指南
    └── IMAGE_PASTE_IMPLEMENTATION_SUMMARY.md  # 实现总结（本文件）
```

## 技术要点

### 1. 元数据传递

通过在 Map 的 key 中编码元数据，实现了信息的传递：

- 网络图片：`network:originalLineText|lineNumber|...|imageUrl|originalMark`
- 文件：`file:原始文件绝对路径|文件名`
- 图片流：直接使用文件名作为 key

### 2. 责任链模式

保持了原有的责任链设计：

```
PasteImageAction
    -> DownloadImageHandler (网络图片)
    -> ImageCompressionHandler
    -> ImageRenameHandler
    -> ImageStorageHandler (本次重构)
    -> RefreshFileSystemHandler
    -> OptionClientHandler
    -> ImageUploadHandler
    -> ImageLabelChangeHandler
    -> InsertToDocumentHandler
    -> FinalChainHandler
```

### 3. 配置驱动

所有行为都由配置参数驱动，便于：

- 用户自定义行为
- 单元测试
- 功能扩展

## 使用示例

### 示例 1: 项目资源管理

**场景**: 希望所有图片统一放在项目的 `assets/images` 目录下

**配置**:

```
applyToLocalImages: true
preferRelativePath: true
addDotSlash: true
currentInsertPath: ./assets/images
autoEscapeImageUrl: false
```

**效果**:

- 所有粘贴的图片都会拷贝到 `./assets/images`
- Markdown 中使用相对路径：`![](./assets/images/xxx.png)`

### 示例 2: 文档分离式管理

**场景**: 图片文件单独管理，不想拷贝到项目中

**配置**:

```
applyToLocalImages: false
preferRelativePath: true
addDotSlash: false
currentInsertPath: ./imgs  (图片流仍需要此路径)
autoEscapeImageUrl: false
```

**效果**:

- 粘贴文件：不拷贝，使用原始相对路径
- 粘贴图片流：保存到 `./imgs`，使用相对路径

### 示例 3: 支持中文路径

**场景**: 使用中文目录名，需要在某些环境下正确显示

**配置**:

```
applyToLocalImages: true
preferRelativePath: true
addDotSlash: true
currentInsertPath: ./图片
autoEscapeImageUrl: true
```

**效果**:

- 图片保存到 `./图片` 目录
- Markdown 中使用转义后的路径：`./%E5%9B%BE%E7%89%87/xxx.png`

## 测试建议

1. **单元测试**: 为 `PathUtils` 的每个方法编写单元测试
2. **集成测试**: 测试 `ImageStorageHandler` 在各种配置下的行为
3. **手动测试**: 使用测试指南进行完整的功能验证
4. **跨平台测试**: 在 Windows、macOS、Linux 上进行测试

## 后续改进建议

1. **性能优化**
    - 对于大图片，考虑异步处理
    - 添加进度反馈

2. **功能增强**
    - 支持批量粘贴多张图片
    - 支持图片重命名模板
    - 支持自动压缩图片

3. **用户体验**
    - 添加配置预设（如"本地模式"、"云端模式"）
    - 提供配置向导
    - 添加图片预览功能

4. **错误处理**
    - 改善错误提示信息
    - 添加错误恢复机制
    - 记录详细的错误日志

## 注意事项

1. **路径分隔符**: 始终使用正斜杠 `/`，即使在 Windows 上
2. **URL 转义**: 只在需要时启用，避免不必要的转义
3. **相对路径**: 确保计算的相对路径能够正确访问到图片
4. **文件拷贝**: 拷贝文件时要注意不要覆盖已存在的文件
5. **网络图片**: 网络图片的处理逻辑与本地图片略有不同

## 版本信息

- **实现日期**: 2025-11-01
- **插件版本**: 2.1.0
- **最低支持 IntelliJ IDEA 版本**: 2022.3

## 参考资料

- [Markdown 图片语法](https://www.markdownguide.org/basic-syntax/#images)
- [URL 编码规范](https://www.rfc-editor.org/rfc/rfc3986)
- [Java Path API](https://docs.oracle.com/javase/tutorial/essential/io/pathOps.html)

## 贡献者

- 主要实现：dong4j
- 测试支持：[待添加]
- 文档整理：dong4j

## 许可证

本功能遵循项目的整体许可证。

